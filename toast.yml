image: python:3.8-slim
command_prefix: set -euo pipefail
tasks:
  install-packages:
    command:
      apt-get update && apt-get install -y curl git make
  install-node:
    dependencies:
      - install-packages
    command: |
      curl -sL https://deb.nodesource.com/setup_lts.x | bash -
      apt-get install -y nodejs
  install:
    dependencies:
      - install-node
    input_paths:
      - Makefile
      - pyproject.toml
      - package.json
      - .pre-commit-config.yaml
    command: |
      # a git repo is needed during pip install by setuptools_scm and later by pre-commit
      git init . --initial-branch=main
      # needed so the editable package (.pth) we install points at src
      mkdir src
      make install
  hooks:
    description: make hooks
    dependencies:
      - install
    input_paths:
    # needed to avoid running hooks on *.egg-info files generated by pip install -e .
      - .gitignore
      - src/
      - tests/
    command: |
      # needed for pre-commit to see files
      git add src tests
      make hooks
