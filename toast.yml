image: python:3.8-slim
command_prefix: set -euo pipefail
tasks:
  install-packages:
    command: |
      apt-get update && apt-get install -y curl git make
      curl -LsSf https://astral.sh/uv/install.sh | sh
  install-node:
    dependencies:
      - install-packages
    command: |
      curl -sL https://deb.nodesource.com/setup_lts.x | bash -
      apt-get install -y nodejs
  install:
    dependencies:
      - install-node
    input_paths:
      - Makefile
      - Makefile-common.mk
      - pyproject.toml
      - package.json
      - .pre-commit-config.yaml
      - .python-version
    command: |
      # add uv to path
      export PATH="/root/.cargo/bin/:$PATH"
      # needed so the editable package (.pth) we install points at src
      mkdir src
      # needed to install hooks
      git init . --initial-branch=main
      make install
  hooks:
    description: make hooks
    dependencies:
      - install
    input_paths:
    # needed to avoid running hooks on *.egg-info files generated by pip install -e .
      - .gitignore
      - src/
      - tests/
    command: |
      # needed for pre-commit to work and see files
      git add src tests
      make hooks
